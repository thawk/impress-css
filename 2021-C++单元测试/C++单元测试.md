# C++单元测试

## 概念

在计算机编程中，单元测试（英语：Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来进行正确性检验的测试工作。
程序单元是应用的最小可测试部件。在过程化编程中，一个单元就是单个程序、函数、过程等；对于面向对象编程，最小单元就是方法，包括基类（超类）、抽象类、或者派生类（子类）中的方法。

* 基本要求
  * 有预期
  * 会失败
  * 少依赖
    * 外部环境
      * 文件
      * 网络
    * 其他类
    * 相互隔离
  * 快执行
    * 不阻塞

## C++单元测试工具

* 单元测试框架： [Boost.Test](http://www.boost.org/libs/test)
* 模拟对象框架： [Turtle](http://turtle.sourceforge.net/)

  A C++ mock object library for Boost。

## Boost.Test常用

## C++单元测试实践

* 单元测试代码的组织
  * 单元测试代码放在``unittest``目录中

  * ``init_test.cpp``文件中存放单元测试初始化代码
    * 日志初始化
    * 设置``test suite``名称
    * 根据日志输出格式（文本/XML，在``Jamfile``中根据是否在持续集成中运行进行设置）

* 原则上每个类对应一个单元测试文件，命名为``test_**类名**.cpp``

## 提高代码的可测试性

* 独立运行
* 覆盖输入
  * 外部输入

    参数、全局变量、成员变量

  * 内部输入
    * 调用其它方法的返回值。

      时钟、硬件信息、操作系统信息、环境变量等内容可能每次都不同。

      一些比较复杂的方法，难以通过传入参数使方法返回想要的值。

    * 局部静态变量

      每个用例的值都不同。

      无法从外部访问。

## 技巧

* 通过重载流插入运算符（<<）把对象变成可读字符串

* 单元测试的并发
  - 进程间可能并发
  - 进程内用例串行
  - 避免在多个线程中同时执行断言

* Fixture
  - 集中初始化、清理环境
  - 跨文件抽取共同部分，方便测试
  - 分阶段Fixture：未初始化、初始化、启动后

* 数据集

* SteadyClock时间

* 协程

* MemoryDataAccess

* WaitTill节省时间

* 分阶段
  * verify

* mock
  * 目标
    * functor
    * 虚函数
  * 依赖注入
    * 定义接口
    * 直接继承

* 输入
  * push
    * 直接调用
  * pull
    * mock
  * callback
    * mock截获回调，再模拟回调

* 输出
  * push
    * mock
  * pull

* 测试内部细节
  * #define private public
  * protected方法
  * Impl模式

* 验证进出消息
  * EqualMessage

* CHECK_MESSAGE + AsHex